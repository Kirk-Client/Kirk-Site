<!-- 
COMPLETE FIXED INDEX.HTML - PASTE THIS ENTIRE FILE
This version removes manual user document creation and lets the Cloud Function handle it
-->

<!-- Keep all your existing HTML/CSS exactly the same -->
<!-- I'm only showing the JavaScript changes you need at the bottom of the file -->

<!-- ADD THIS SCRIPT SECTION AT THE VERY END, BEFORE </body> -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDnppB7CXp0eZLNhvXeyKNDvO0R1YVsf2I",
        authDomain: "kirkclient.firebaseapp.com",
        projectId: "kirkclient",
        storageBucket: "kirkclient.firebasestorage.app",
        messagingSenderId: "324941983054",
        appId: "1:324941983054:web:2976a14fc5cc05d89d021f",
        measurementId: "G-E0ZPPKNBD8"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let cart = [];

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            await loadCartFromFirestore();
            updateUIForLogin();
            console.log('ðŸ” Logged in:', user.email);
            console.log('ðŸ†” User ID:', user.uid);
        } else {
            currentUser = null;
            cart = [];
            updateUIForLogout();
        }
    });

    // Show error message
    function showError(elementId, message) {
        const errorEl = document.getElementById(elementId);
        errorEl.textContent = message;
        errorEl.className = 'error-message';
        errorEl.style.display = 'block';
    }

    // Show success message
    function showSuccess(elementId, message) {
        const successEl = document.getElementById(elementId);
        successEl.textContent = message;
        successEl.className = 'success-message';
        successEl.style.display = 'block';
    }

    window.openLoginModal = () => {
        document.getElementById('loginModal').classList.add('active');
        document.getElementById('loginError').style.display = 'none';
    };

    window.closeLoginModal = () => {
        document.getElementById('loginModal').classList.remove('active');
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('loginError').style.display = 'none';
    };

    window.openSignupModal = () => {
        document.getElementById('signupModal').classList.add('active');
        document.getElementById('signupError').style.display = 'none';
    };

    window.closeSignupModal = () => {
        document.getElementById('signupModal').classList.remove('active');
        document.getElementById('signupUsername').value = '';
        document.getElementById('signupEmail').value = '';
        document.getElementById('signupPassword').value = '';
        document.getElementById('signupError').style.display = 'none';
    };

    window.switchToSignup = () => {
        closeLoginModal();
        openSignupModal();
    };

    window.switchToLogin = () => {
        closeSignupModal();
        openLoginModal();
    };

    // Login handler
    window.handleLoginSubmit = async (event) => {
        event.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const submitBtn = document.getElementById('loginSubmitBtn');

        submitBtn.disabled = true;
        submitBtn.textContent = 'Logging in...';

        try {
            await signInWithEmailAndPassword(auth, email, password);
            closeLoginModal();
            showSuccess('loginError', 'Login successful!');
        } catch (error) {
            console.error('âŒ Login error:', error);
            let errorMessage = 'Login failed. Please try again.';
            
            if (error.code === 'auth/user-not-found') {
                errorMessage = 'No account found with this email.';
            } else if (error.code === 'auth/wrong-password') {
                errorMessage = 'Incorrect password.';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'Invalid email address.';
            } else if (error.code === 'auth/too-many-requests') {
                errorMessage = 'Too many failed attempts. Please try again later.';
            } else if (error.code === 'auth/invalid-credential') {
                errorMessage = 'Invalid email or password.';
            }
            
            showError('loginError', errorMessage);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign In';
        }
    };

    // SIMPLIFIED Signup handler - Cloud Function handles user document creation!
    window.handleSignupSubmit = async (event) => {
        event.preventDefault();
        
        const username = document.getElementById('signupUsername').value.trim();
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const submitBtn = document.getElementById('signupSubmitBtn');

        if (username.length < 3) {
            showError('signupError', 'Username must be at least 3 characters long.');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating account...';

        try {
            // Create Firebase Auth account
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // Set display name
            await updateProfile(user, {
                displayName: username
            });

            // âœ… DON'T create user document manually!
            // The Cloud Function onUserCreate will automatically create it!
            console.log('âœ… Account created! Cloud Function will create user document.');
            console.log('ðŸ†” User ID:', user.uid);
            console.log('ðŸ“§ Email:', user.email);
            console.log('ðŸ‘¤ Username:', username);
            
            showSuccess('signupError', 'Account created successfully! HWID will be set when you open the client.');
            
            setTimeout(() => {
                closeSignupModal();
            }, 2000);

        } catch (error) {
            console.error('âŒ Signup error:', error);
            let errorMessage = 'Signup failed. Please try again.';
            
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = 'An account with this email already exists.';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'Invalid email address.';
            } else if (error.code === 'auth/weak-password') {
                errorMessage = 'Password should be at least 6 characters.';
            }
            
            showError('signupError', errorMessage);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Account';
        }
    };

    // Logout handler
    window.handleLogout = async () => {
        try {
            await signOut(auth);
            console.log('âœ… Logged out successfully');
        } catch (error) {
            console.error('âŒ Logout error:', error);
            alert('Failed to logout. Please try again.');
        }
    };

    function updateUIForLogin() {
        document.getElementById('authButtons').style.display = 'none';
        document.getElementById('cartBtn').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'block';
    }

    function updateUIForLogout() {
        document.getElementById('authButtons').style.display = 'flex';
        document.getElementById('cartBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'none';
        updateCartCount();
    }

    window.openShop = () => {
        if (!currentUser) {
            alert('Please log in to access the shop');
            openLoginModal();
            return;
        }
        document.getElementById('shopModal').classList.add('active');
    };

    window.closeShop = () => {
        document.getElementById('shopModal').classList.remove('active');
    };

    window.openCart = () => {
        updateCartDisplay();
        document.getElementById('cartModal').classList.add('active');
    };

    window.closeCart = () => {
        document.getElementById('cartModal').classList.remove('active');
    };

    window.addToCart = async (productName, price) => {
        if (!currentUser) {
            alert('Please log in to add items to cart');
            return;
        }
        
        try {
            const cartItem = {
                userId: currentUser.uid,
                name: productName,
                price: price,
                timestamp: new Date()
            };
            
            const docRef = await addDoc(collection(db, 'carts'), cartItem);
            cart.push({ id: docRef.id, name: productName, price: price });
            updateCartCount();
            alert(`${productName} added to cart!`);
            closeShop();
        } catch (error) {
            console.error('Error adding to cart:', error);
            alert('Failed to add item to cart. Please try again.');
        }
    };

    async function loadCartFromFirestore() {
        if (!currentUser) return;
        
        try {
            const q = query(collection(db, 'carts'), where('userId', '==', currentUser.uid));
            const querySnapshot = await getDocs(q);
            
            cart = [];
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                cart.push({
                    id: docSnap.id,
                    name: data.name,
                    price: data.price
                });
            });
            
            updateCartCount();
        } catch (error) {
            console.error('Error loading cart:', error);
        }
    }

    window.removeFromCart = async (index) => {
        const item = cart[index];
        
        try {
            if (item.id) {
                await deleteDoc(doc(db, 'carts', item.id));
            }
            cart.splice(index, 1);
            updateCartCount();
            updateCartDisplay();
        } catch (error) {
            console.error('Error removing from cart:', error);
            alert('Failed to remove item. Please try again.');
        }
    };

    function updateCartCount() {
        document.getElementById('cartCount').textContent = cart.length;
    }

    function updateCartDisplay() {
        const cartItemsContainer = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<div class="cart-empty">Your cart is empty</div>';
            cartTotal.style.display = 'none';
        } else {
            let total = 0;
            cartItemsContainer.innerHTML = cart.map((item, index) => {
                total += item.price;
                return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <p>$${item.price.toFixed(2)}</p>
                        </div>
                        <button class="cart-item-remove" onclick="removeFromCart(${index})">Remove</button>
                    </div>
                `;
            }).join('');
            
            document.getElementById('totalAmount').textContent = total.toFixed(2);
            cartTotal.style.display = 'block';
        }
    }

    window.checkout = () => {
        if (cart.length === 0) return;
        
        // Store cart in sessionStorage for checkout page
        sessionStorage.setItem('kirkClientCart', JSON.stringify(cart));
        
        // Redirect to checkout
        window.location.href = 'checkout.html';
    };

    // Close modals when clicking outside
    document.getElementById('shopModal').addEventListener('click', function(e) {
        if (e.target === this) closeShop();
    });

    document.getElementById('cartModal').addEventListener('click', function(e) {
        if (e.target === this) closeCart();
    });

    document.getElementById('loginModal').addEventListener('click', function(e) {
        if (e.target === this) closeLoginModal();
    });

    document.getElementById('signupModal').addEventListener('click', function(e) {
        if (e.target === this) closeSignupModal();
    });
</script>
